/* ==========================================================================
   YTMUSIC PATCHING & LAYOUT
   ========================================================================== */

/* Hide default YouTube Music lyrics UI components when Lyrics Plus is active */
ytmusic-section-list-renderer[page-type="MUSIC_PAGE_TYPE_TRACK_LYRICS"] #contents.ytmusic-section-list-renderer,
ytmusic-message-renderer.style-scope.ytmusic-tab-renderer[style=""],
ytmusic-tab-renderer:has(#lyrics-plus-container[style*="display: block"]) ytmusic-message-renderer,
ytmusic-tab-renderer:has(#lyrics-plus-container[style*="display: block"]) .loading-spinner {
    display: none !important;
}

ytmusic-app-layout[player-fullscreened] .song-media-controls.ytmusic-player {
    background: none;
}

/* Use song-art palette for lyrics in word-by-word mode */
ytmusic-player-page[video-mode]:not([is-video-truncation-fix-enabled])[player-fullscreened] #lyrics-plus-container.use-song-palette-fullscreen.word-by-word-mode,
#lyrics-plus-container.use-song-palette-all-modes.word-by-word-mode {
    --lyplus-lyrics-pallete: var(--lyplus-song-pallete);
}

/* Use white-variant of song-art palette for lyrics in line-by-line mode */
ytmusic-player-page[video-mode]:not([is-video-truncation-fix-enabled])[player-fullscreened] #lyrics-plus-container.use-song-palette-fullscreen.line-by-line-mode,
#lyrics-plus-container.use-song-palette-all-modes.line-by-line-mode {
    --lyplus-lyrics-pallete: var(--lyplus-song-pallete);
}


ytmusic-tab-renderer:has(#lyrics-plus-container[style*="display: block"]) {
    --lyrics-scroll-padding-top: 25%;
    scroll-padding-top: 25%;
    scroll-padding-block-start: 25%;
    overflow-anchor: auto;
    scrollbar-width: none;
    will-change: scroll-position;
    scroll-snap-type: y proximity;
}

ytmusic-app-layout[is-mweb-modernization-enabled] ytmusic-tab-renderer:has(#lyrics-plus-container[style*="display: block"]) {
    --lyrics-scroll-padding-top: 10%;
}

/* Modern mobile layout font size */
ytmusic-app-layout[is-mweb-modernization-enabled] .lyrics-plus-integrated .lyrics-line {
    font-size: 34px;
    --lyplus-font-size-base-grow: 24;
}


/* Show buttons only when lyrics are visible */
ytmusic-tab-renderer:has(#lyrics-plus-container[style*="display: block"]) #lyrics-plus-buttons-wrapper {
    display: flex;
}


/* --- Dynamic Player UI Integration --- */

/* Show blur background when player page is open or in fullscreen */
#layout.dynamic-player[player-ui-state="PLAYER_PAGE_OPEN"] .lyplus-blur-container,
#layout.dynamic-player[is-mweb-modernization-enabled][player-ui-state="MINIPLAYER_IN_PLAYER_PAGE"] .lyplus-blur-container,
ytmusic-app #layout[player-ui-state="FULLSCREEN"] .lyplus-blur-container {
    display: block;
    opacity: 1;
}

#layout.dynamic-player[player-ui-state="PLAYER_PAGE_OPEN"] .ytmusic-browse-response,
#layout.dynamic-player[is-mweb-modernization-enabled][player-ui-state="MINIPLAYER_IN_PLAYER_PAGE"] .ytmusic-browse-response,
ytmusic-app #layout[player-ui-state="FULLSCREEN"] .ytmusic-browse-response {
    display: none;
}

/* Make backgrounds transparent to reveal the blur container */
#layout.dynamic-player[player-ui-state="PLAYER_PAGE_OPEN"] #mini-guide-background,
#layout.dynamic-player[player-ui-state="PLAYER_PAGE_OPEN"] #nav-bar-background,
#layout.dynamic-player[player-ui-state="PLAYER_PAGE_OPEN"] #guide-wrapper,
#layout.dynamic-player[player-ui-state="PLAYER_PAGE_OPEN"] ytmusic-player-page#player-page,
#layout.dynamic-player[player-ui-state="PLAYER_PAGE_OPEN"] #player-bar-background,
#layout.dynamic-player[player-ui-state="PLAYER_PAGE_OPEN"] ytmusic-player-bar,
#layout.dynamic-player[player-ui-state="PLAYER_PAGE_OPEN"] #nav-bar-divider.ytmusic-app-layout {
    background: transparent !important;
}

#layout.dynamic-player[player-ui-state="PLAYER_PAGE_OPEN"] #nav-bar-divider.ytmusic-app-layout,
#layout.dynamic-player[player-ui-state="MINIPLAYER_IN_PLAYER_PAGE"] #nav-bar-divider.ytmusic-app-layout,
#layout.dynamic-player[player-ui-state="PLAYER_PAGE_OPEN"] #mini-guide-background,
#layout.dynamic-player[player-ui-state="PLAYER_PAGE_OPEN"] #nav-bar-background {
    border-color: transparent !important;
}

/* Style adjustments for modern mobile view */
#layout.dynamic-player[is-mweb-modernization-enabled] .side-panel.ytmusic-player-page,
#layout.dynamic-player[is-mweb-modernization-enabled][player-page-ui-state="TABS_VIEW"] #side-panel.ytmusic-player-page,
#layout.dynamic-player[is-mweb-modernization-enabled][player-ui-state="PLAYER_PAGE_OPEN"] .background-gradient,
#layout.dynamic-player[is-mweb-modernization-enabled][player-ui-state="MINIPLAYER_IN_PLAYER_PAGE"] .background-gradient,
#layout.dynamic-player[is-mweb-modernization-enabled][player-ui-state="MINIPLAYER_IN_PLAYER_PAGE"] #player-page,
#layout.dynamic-player[is-mweb-modernization-enabled][player-ui-state="MINIPLAYER_IN_PLAYER_PAGE"] #top-player-bar,
#layout.dynamic-player[is-mweb-modernization-enabled][player-ui-state="MINIPLAYER_IN_PLAYER_PAGE"] #player-bar-background,
#layout.dynamic-player[is-mweb-modernization-enabled][player-ui-state="MINIPLAYER_IN_PLAYER_PAGE"] #nav-bar-background,
#layout.dynamic-player[is-mweb-modernization-enabled][player-ui-state="MINIPLAYER_IN_PLAYER_PAGE"] #mini-guide,
#layout.dynamic-player[is-mweb-modernization-enabled][player-ui-state="MINIPLAYER_IN_PLAYER_PAGE"] #mini-guide-background,
#layout.dynamic-player[is-mweb-modernization-enabled][player-ui-state="PLAYER_PAGE_OPEN"] #mini-guide {
    background: none !important;
}

/* Hide the default image to prevent conflict with our blur container */
#layout.dynamic-player .background-image {
    visibility: hidden !important;
}

#layout.dynamic-player[player-ui-state="PLAYER_PAGE_OPEN"] .lyplus-blur-container::after {
    backdrop-filter: brightness(0.5) saturate(1.55) contrast(0.95);
}

#layout.dynamic-player[player-ui-state="PLAYER_PAGE_OPEN"] ytmusic-player-bar {
    backdrop-filter: blur(20px);
}

#layout.dynamic-player[player-ui-state="PLAYER_PAGE_OPEN"] :not([player-fullscreened]) ytmusic-player {
    border: 1px solid #afafaf2c;
    overflow: hidden;
    border-radius: 2em;
    box-shadow: 0 1em 3em #00000038;
}

/* --- Song Information Display (Fullscreen) --- */
.lyrics-song-container {
    margin-top: 1em;
    display: none;
}

#lyrics-song-title {
    font-size: 2rem;
    font-weight: 700;
    color: #ffffffeb;
    margin: 0 0 0.25rem 0;
    line-height: 1.1;
}

#lyrics-song-artist {
    font-size: 1.7rem !important;
    font-weight: 700 !important;
    color: #ffffffa3 !important;
    margin: 0 !important;
    line-height: 1.1 !important;
}

.progress-container svg {
    width: 100%;
    height: 100%;
    overflow: visible;
    padding: none;
}

.progress-container .track,
.progress-container .progress {
    fill: none;
    stroke-width: var(--progress-stroke-width);
    stroke-linecap: round;
}

.progress-container .track {
    stroke: var(--track-color);
}

.progress-container .progress {
    stroke: var(--progress-color);
}

.progress-container .thumb {
    fill: var(--thumb-color);
    rx: var(--thumb-radius);
    ry: var(--thumb-radius);
    will-change: transform;
}

div#lyrics-song-progressbar {
    height: 30px;
    width: 100%;
}

/* ==========================================================================
   DESKTOP & FULLSCREEN STYLES (@media)
   ========================================================================== */

@media (min-width: 615px) {

    ytmusic-player-page[player-fullscreened] #lyrics-plus-buttons-wrapper {
        display: none !important;
    }

    ytmusic-app-layout[player-fullscreened][show-fullscreen-controls]>[slot="player-bar"] {
        width: 100%;
    }

    ytmusic-player-page:not([video-mode]):not([player-fullscreened]):not([player-ui-state="MINIPLAYER"]) #player.ytmusic-player-page {
        left: 50%;
        max-width: 400px !important;
        transform: translateX(-55%);
    }

    ytmusic-player-page:not([is-mweb-modernization-enabled])[player-fullscreened] .av.ytmusic-player-page {
        width: 40% !important;
    }

    ytmusic-player-page:is(:not([video-mode]), [video-mode]:has(ytmusic-player[playback-mode="ATV_PREFERRED"])):not([is-video-truncation-fix-enabled])[player-fullscreened]:has(#lyrics-plus-container[style*="display: block"]) #player.ytmusic-player-page {
        /*top: calc(45% - var(--ytmusic-nav-bar-height)); */
        top: calc(50% - var(--ytmusic-nav-bar-height));
        left: 28%;
        width: 39rem;
        height: 39rem;
        transform: translate(-60%, -50%);
        overflow: visible;
        background: none !important;
    }

    ytmusic-player-page:is(:not([video-mode]), [video-mode]:has(ytmusic-player[playback-mode="ATV_PREFERRED"])):not([is-video-truncation-fix-enabled])[player-fullscreened]:has(#lyrics-plus-container[style*="display: block"]) #song-image img {
        border: 1px solid #afafaf2c;
        overflow: hidden;
        border-radius: 2em;
        box-shadow: 0 1em 3em #00000038;
        mask-image: none !important;
    }

    ytmusic-player-page:is(:not([video-mode]), [video-mode]:has(ytmusic-player[playback-mode="ATV_PREFERRED"])):not([is-video-truncation-fix-enabled])[player-fullscreened]:has(#lyrics-plus-container[style*="display: block"]) .lyrics-song-container {
        display: block;
    }

    ytmusic-app-layout:not([is-mweb-modernization-enabled])[player-fullscreened]>[slot="player-page"] {
        width: 100% !important;
        height: 100% !important;
        background: none !important;
    }

    ytmusic-app-layout:not([is-mweb-modernization-enabled])[player-fullscreened]>[slot="player-page"] .tab-header-container {
        display: none !important;
    }

    ytmusic-app-layout:not([is-mweb-modernization-enabled])[player-fullscreened]>[slot="player-page"] #side-panel {
        min-width: 50%;
        mask-image: linear-gradient(to bottom, transparent 0%, black 26%, black 70%, transparent 100%);
        transform: translateY(-8.8rem);
    }

    ytmusic-app-layout:not([is-mweb-modernization-enabled])[player-fullscreened] .lyplus-blur-container .lyplus-gradient-overlay {
        opacity: 0;
    }

    ytmusic-app-layout:not([is-mweb-modernization-enabled])[player-fullscreened]>[slot="player-page"] #lyrics-plus-container {
        margin-top: 10%;
        padding-top: calc(1em + 40%);
    }

    ytmusic-app-layout:not([is-mweb-modernization-enabled])[player-fullscreened]>[slot="player-page"] #side-panel .lyrics-line {
        margin-bottom: .5rem;
        font-size: 4.5rem;
        --lyplus-font-size-base-grow: 25;
    }

    ytmusic-app-layout:not([is-mweb-modernization-enabled])[player-fullscreened]>[slot="player-page"] .lyrics-line:not(.active):not(.lyrics-gap) .lyrics-line-container {
        transform: scale3d(0.8, 0.8, 0.95);
    }

    ytmusic-player-page:is(:not([video-mode]), [video-mode]:has(ytmusic-player[playback-mode="ATV_PREFERRED"])):not([is-video-truncation-fix-enabled])[player-fullscreened] #lyrics-plus-container[style*="display: block"] {
        scroll-padding-top: 35%;
        scroll-padding-block-start: 35%;
    }

    ytmusic-player-page[video-mode]:not(:has(ytmusic-player[playback-mode="ATV_PREFERRED"])):not([is-video-truncation-fix-enabled])[player-fullscreened]:has(#lyrics-plus-container[style*="display: block"]) #lyrics-plus-container {
        margin-top: 0;
        padding-top: 0;
    }

    ytmusic-player-page[video-mode]:not(:has(ytmusic-player[playback-mode="ATV_PREFERRED"])):not([is-video-truncation-fix-enabled])[player-fullscreened]:has(#lyrics-plus-container[style*="display: block"]) #side-panel {
        position: absolute;
        bottom: 9rem;
        left: 0;
        z-index: 2;
        width: 100vw !important;
        min-width: 100vw;
        height: 9em;
        margin: 0;
        box-sizing: border-box;
        text-align: center !important;
        pointer-events: none;
        overflow: visible;
        mask-image: none;
    }

    ytmusic-player-page[video-mode]:not(:has(ytmusic-player[playback-mode="ATV_PREFERRED"])):not([is-video-truncation-fix-enabled])[player-fullscreened]:has(#lyrics-plus-container[style*="display: block"]) ytmusic-tab-renderer {
        overflow: visible !important;
    }

    ytmusic-player-page[video-mode]:not(:has(ytmusic-player[playback-mode="ATV_PREFERRED"])):not([is-video-truncation-fix-enabled])[player-fullscreened]:has(#lyrics-plus-container[style*="display: block"]) .lyrics-line {
        display: none;
        /* Hide all lines by default */
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
        opacity: 0;
        text-align: center !important;
        transform: none !important;
    }

    /* Only show the active and adjacent lines */
    ytmusic-player-page[video-mode]:not(:has(ytmusic-player[playback-mode="ATV_PREFERRED"])):not([is-video-truncation-fix-enabled])[player-fullscreened]:has(#lyrics-plus-container[style*="display: block"]) .lyrics-line.lyrics-activest,
    ytmusic-player-page[video-mode]:not(:has(ytmusic-player[playback-mode="ATV_PREFERRED"])):not([is-video-truncation-fix-enabled])[player-fullscreened]:has(#lyrics-plus-container[style*="display: block"]) .lyrics-line.next-active-line,
    ytmusic-player-page[video-mode]:not(:has(ytmusic-player[playback-mode="ATV_PREFERRED"])):not([is-video-truncation-fix-enabled])[player-fullscreened]:has(#lyrics-plus-container[style*="display: block"]) .lyrics-line.post-active-line {
        display: block;
    }

    ytmusic-player-page[video-mode]:not(:has(ytmusic-player[playback-mode="ATV_PREFERRED"])):not([is-video-truncation-fix-enabled])[player-fullscreened]:has(#lyrics-plus-container[style*="display: block"]) .lyrics-line.fullscreen-focused.active {
        opacity: 1;
        filter: drop-shadow(0 0 0.1em rgba(0, 0, 0, 1));
    }

    ytmusic-player-page[video-mode]:not(:has(ytmusic-player[playback-mode="ATV_PREFERRED"])):not([is-video-truncation-fix-enabled])[player-fullscreened]:has(#lyrics-plus-container[style*="display: block"]) span.lyrics-song-writters,
    ytmusic-player-page[video-mode]:not(:has(ytmusic-player[playback-mode="ATV_PREFERRED"])):not([is-video-truncation-fix-enabled])[player-fullscreened]:has(#lyrics-plus-container[style*="display: block"]) span.lyrics-source-provider {
        display: none;
    }

    ytmusic-player-page[video-mode]:not(:has(ytmusic-player[playback-mode="ATV_PREFERRED"])):not([is-video-truncation-fix-enabled])[player-fullscreened]:has(#lyrics-plus-container[style*="display: block"]) .lyrics-line.lyrics-gap .main-vocal-container {
        transform-origin: center !important;
    }


    ytmusic-player-page[player-fullscreened] #lyrics-plus-container:not(.not-focused) .lyrics-line:has(~ .lyrics-line.lyrics-activest) .background-vocal-container,
    ytmusic-player-page[player-fullscreened] #lyrics-plus-container:not(.not-focused) .lyrics-line:has(~ .lyrics-plus-metadata.lyrics-activest) .background-vocal-container {
        max-height: 10em;
    }

    ytmusic-player-page[player-fullscreened] #lyrics-plus-container:not(.not-focused) .lyrics-line:not(.lyrics-gap):has(~ .lyrics-line.lyrics-activest),
    ytmusic-player-page[player-fullscreened] #lyrics-plus-container:not(.not-focused) .lyrics-line:not(.lyrics-gap):has(~ .lyrics-plus-metadata.lyrics-activest) {
        opacity: 0;
        transition: opacity 0.3s ease 0.3s, transform 0.4s ease var(--lyrics-line-delay, 0ms), filter 0.3s ease;
    }

    ytmusic-player-page[player-fullscreened] #lyrics-plus-container span.lyrics-song-writters {
        font-size: 200%;
    }

    ytmusic-player-page[video-mode]:not(:has(ytmusic-player[playback-mode="ATV_PREFERRED"])):not([is-video-truncation-fix-enabled])[player-fullscreened] #lyrics-plus-container .text-loading,
    ytmusic-player-page[video-mode]:not(:has(ytmusic-player[playback-mode="ATV_PREFERRED"])):not([is-video-truncation-fix-enabled])[player-fullscreened] #lyrics-plus-container .text-not-found {
        display: none;
    }
}

#lyrics-plus-container {
    --lyplus-font-family: Roboto;
    /*Yt sans are ugly i swear*/
}

/* Fix UI when user using ThemeSong Extension, so using this css will aloow them to use
Lyrics+ without any visual bug*/
#songDivContainer {
    display: none !important;
}

:root:has(#ThemeSong-MainContainer) {
    #thumbnail>img {
        object-fit: contain !important;
    }

    #layout.dynamic-player #player-page,
    #player-page[player-fullscreened] {
        background: none !important;
    }

    ytmusic-app-layout[player-fullscreened] #player-bar-background.ytmusic-app-layout {
        display: block;
        backdrop-filter: none !important;
        background: transparent !important;
    }

    body:has(#ThemeSong-MainContainer #DynamicLight) #lyrics-plus-container,
    body:has(#ThemeSong-MainContainer #StaticLight) #lyrics-plus-container {
        --lyplus-lyrics-pallete: var(--ts-palette-darkmuted-hex, #111) !important;
        --lyplus-text-secondary: #1116;
        --lyplus-text-tertiary: #ffffff7a;
        --lyplus-text-inactive: #ffffff31;
    }

    body:has(#ThemeSong-MainContainer #DynamicLight) #lyrics-plus-translate-button svg,
    body:has(#ThemeSong-MainContainer #StaticLight) #lyrics-plus-translate-button svg,
    body:has(#ThemeSong-MainContainer #DynamicLight) #lyrics-plus-reload-button svg,
    body:has(#ThemeSong-MainContainer #StaticLight) #lyrics-plus-reload-button svg {
        fill: #212121;
    }


    body:has(#ThemeSong-MainContainer #DynamicLight) .lyplus-blur-container::after,
    body:has(#ThemeSong-MainContainer #StaticLight) .lyplus-blur-container::after {
        backdrop-filter: saturate(1.4);
    }

    body:has(#ThemeSong-MainContainer #DynamicLight) .lyplus-blur-container canvas,
    body:has(#ThemeSong-MainContainer #StaticLight) .lyplus-blur-container canvas {
        opacity: .4;
        filter: brightness(1.8) contrast(0.6);
    }

    #song-image #img {
        height: 100% !important;
        width: 100% !important;
    }

    #song-image {
        background: none !important;
        box-shadow: 0 0 0 black !important;
        border: 0 solid black !important;
    }

}